"use strict";(self.webpackChunkvolca_docs=self.webpackChunkvolca_docs||[]).push([[299],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>g});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),c=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},m=function(e){var n=c(e.components);return r.createElement(s.Provider,{value:n},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),u=c(t),d=a,g=u["".concat(s,".").concat(d)]||u[d]||p[d]||i;return t?r.createElement(g,o(o({ref:n},m),{},{components:t})):r.createElement(g,o({ref:n},m))}));function g(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[u]="string"==typeof e?e:a,o[1]=l;for(var c=2;c<i;c++)o[c]=t[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},9936:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=t(7462),a=(t(7294),t(3905));const i={sidebar_position:7},o="Migrations",l={unversionedId:"migrations",id:"migrations",title:"Migrations",description:"Migrations are a way to version control your database schema. A migration might create a table, add a column, remove a column or rename a column. Migrations in Volca are handled by Knex under the hood. For defining a new migration, please refer to the Knex docs.",source:"@site/docs/migrations.md",sourceDirName:".",slug:"/migrations",permalink:"/docs/migrations",draft:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Configuration",permalink:"/docs/configuration"},next:{title:"Examples",permalink:"/docs/category/examples"}},s={},c=[{value:"How to create a migration",id:"how-to-create-a-migration",level:2},{value:"How to run migrations",id:"how-to-run-migrations",level:2},{value:"Locally",id:"locally",level:3},{value:"In AWS environments",id:"in-aws-environments",level:3},{value:"All migration commands",id:"all-migration-commands",level:3}],m={toc:c};function u(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,r.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"migrations"},"Migrations"),(0,a.kt)("p",null,"Migrations are a way to version control your database schema. A migration might create a table, add a column, remove a column or rename a column. Migrations in Volca are handled by ",(0,a.kt)("a",{parentName:"p",href:"https://knexjs.org/guide/migrations.html"},"Knex")," under the hood. For defining a new migration, please refer to the Knex docs."),(0,a.kt)("h2",{id:"how-to-create-a-migration"},"How to create a migration"),(0,a.kt)("p",null,"All migrations reside in the file ",(0,a.kt)("inlineCode",{parentName:"p"},"services/api/src/lib/db/migrations.ts"),". Each migration is inside an array and looks like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="services/api/src/lib/db/migrations.ts"',title:'"services/api/src/lib/db/migrations.ts"'},"...\n{\n    name: '02_create_users_table',\n    up: (knex: Knex) => {\n        return knex.schema.createTable('users', (table) => {\n        table.uuid('id').defaultTo(knex.raw('uuid_generate_v4()')).primary();\n        table.string('email').unique().notNullable();\n        table.string('password').nullable();\n        table.string('first_name').nullable();\n        table.string('last_name').nullable();\n        });\n    },\n    down: (knex: Knex) => {\n        return knex.schema.dropTable('users');\n    },\n},\n...\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"up")," function runs when you apply your migration and the ",(0,a.kt)("inlineCode",{parentName:"p"},"down")," function runs when you roll back your migration."),(0,a.kt)("h2",{id:"how-to-run-migrations"},"How to run migrations"),(0,a.kt)("p",null,"Migrations can be run for your local environment as well as your environments that are deployed to AWS as long as you can access the database from your local machine."),(0,a.kt)("h3",{id:"locally"},"Locally"),(0,a.kt)("p",null,"To run migrations locally, start your project using ",(0,a.kt)("inlineCode",{parentName:"p"},"yarn start")," from the root folder. Then navigate to ",(0,a.kt)("inlineCode",{parentName:"p"},"services/api")," and run ",(0,a.kt)("inlineCode",{parentName:"p"},"yarn migrate:latest:local"),". This will run all migrations that have not yet been applied."),(0,a.kt)("h3",{id:"in-aws-environments"},"In AWS environments"),(0,a.kt)("p",null,"To run migrations for AWS environments, navigate to ",(0,a.kt)("inlineCode",{parentName:"p"},"services/api")," and run ",(0,a.kt)("inlineCode",{parentName:"p"},"yarn migrate:latest:<environment>")," with the correct AWS profile set in your CLI."),(0,a.kt)("h3",{id:"all-migration-commands"},"All migration commands"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"yarn migrate:latest:<environment>")," Runs all migrations that have not yet been applied"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"yarn migrate:up:<environment>")," Runs the next chronological migration that has not yet been run"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"yarn migrate:down:<environment>")," Will undo the last migration that was run")))}u.isMDXComponent=!0}}]);